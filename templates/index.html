<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Fluffy Robot Dashboard</title>
        <script src="https://unpkg.com/htmx.org@1.9.10"></script>
        <script src="https://go-echarts.github.io/go-echarts-assets/assets/echarts.min.js"></script>
        <link rel="stylesheet" href="static/style.css">
    </head>
    <body>
        <header>
        </header>
        <nav>
            <div {{if .AgentVals}}
                hx-vals='{"paramAgents": "{{printf `%s` .AgentVals}}"}'
                {{end}}
                >
                <div hx-vals='js:{storageAgents: getStoredAgentsForHxVals()}'>
                    <span>
                        Time range: 
                        <button class="time-button" hx-get="/chart" hx-vals='{"period":"1h"}'  hx-target="#chart-content">Last 1h</button>
                        <button class="time-button" hx-get="/chart" hx-vals='{"period":"4h"}'  hx-target="#chart-content">Last 4h</button>
                        <button class="time-button" hx-get="/chart" hx-vals='{"period":"24h"}' hx-target="#chart-content">Last 24h</button>
                        <button class="time-button" hx-get="/chart" hx-vals='{"period":"7d"}'  hx-target="#chart-content">Last 7d</button>
                    </span>
                    <span>
                        <button class="config-button" hx-get="/agentlist" hx-target="#chart-content" aria-label="Configuration">&#x2699;</button>
                    </span>
                </div>
            </div>
        </nav>

        <main>   
            <h2>Chart Visualization</h2>
            <div id="chart-content">
                Click a filter button to load a chart.
            </div>
        </main>
        <footer>
            This will be a small about page, maybe a link to github and railway
        </footer>
        <script>
            const AGENT_STORAGE_KEY = 'selected-agents';
            const CLASS_SELECTED = 'agent-selected';
            const CLASS_UNSELECTED = 'agent-unselected';

            function toggleAgentSelection(agentName) {
                const agentButton = document.getElementById(`btn-${agentName}`);

                if (!agentButton) {
                    console.error(`Button for agent ${agentName} not found.`);
                    return;
                }

                let selectedAgents = (localStorage.getItem(AGENT_STORAGE_KEY) || '').split(',').filter(Boolean);
                const agentIndex = selectedAgents.indexOf(agentName);
                const isCurrentlySelected = agentIndex > -1;

                let newAction; // 'add' or 'remove'

                if (isCurrentlySelected) {
                    // Agent is currently selected -> REMOVE it
                    selectedAgents.splice(agentIndex, 1);
                    newAction = 'remove';
                } else {
                    // Agent is NOT selected -> ADD it
                    selectedAgents.push(agentName);
                    newAction = 'add';
                }

                localStorage.setItem(AGENT_STORAGE_KEY, selectedAgents.join(','));

                if (newAction === 'add') {
                    agentButton.classList.add(CLASS_SELECTED);
                    agentButton.classList.remove(CLASS_UNSELECTED);
                } else { // 'remove'
                    agentButton.classList.add(CLASS_UNSELECTED);
                    agentButton.classList.remove(CLASS_SELECTED);
                }

                console.log(`Agent ${agentName} ${newAction}ed. Stored list: ${selectedAgents.join(',')}`);
            }

            function getStoredAgentsForHxVals() {
                // Get the string from localStorage
                const savedAgents = localStorage.getItem(AGENT_STORAGE_KEY) || '';
                console.log("this got called")
                console.log(savedAgents)
                // Format the string for hx-vals: 'agentList:Alpha,Charlie'
                return `${savedAgents}`;
            }
        </script>
    </body>
</html>

