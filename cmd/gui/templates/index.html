<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Fluffy Robot Dashboard</title>
        <script src="https://unpkg.com/htmx.org@1.9.10"></script>
        <script src="https://go-echarts.github.io/go-echarts-assets/assets/echarts.min.js"></script>
        <link rel="stylesheet" href="static/style.css">
    </head>
    <body hx-headers='{"X-CSRF-Token": "tbd"}'>
        <div class="app-container">
            {{template "nav.html" .}}
            
            <main id="main-content">
                {{template "header.html" .}}
                
                <div id="content-area" 
                     hx-get="/chart" 
                     hx-vals='js:{storageAgents: getStoredAgentsForHxVals(), period: "1h"}' 
                     hx-trigger="load delay:100ms">
                    <!-- Initial content will be loaded here -->
                    <div class="loading">Loading dashboard...</div>
                </div>
            </main>
        </div>

        <footer>
            <p>Spacetraders Credit Report - 2026</p>
            <div class="footer-links">
                <a href="https://github.com/papaburgs/fluffy-robot" target="_blank" rel="noopener noreferrer">GitHub</a>
                <a href="https://railway.com?referralCode=-I-osp" target="_blank" rel="noopener noreferrer">Hosted on Railway</a>
            </div>
        </footer>

        <script>
            // Sidebar Logic
            const sidebar = document.getElementById('sidebar');
            const openBtn = document.getElementById('open-sidebar');
            const closeBtn = document.getElementById('close-sidebar');
            const mainContent = document.getElementById('main-content');

            openBtn.addEventListener('click', () => {
                sidebar.classList.add('open');
            });

            closeBtn.addEventListener('click', () => {
                sidebar.classList.remove('open');
            });

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && 
                    !sidebar.contains(e.target) && 
                    !openBtn.contains(e.target) && 
                    sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                }
            });

            // Preferences Logic
            const AGENT_STORAGE_KEY = 'selected-agents';
            const MY_AGENT_KEY = 'my-agent';

            function toggleAgentSelection(agentName) {
                let selectedAgents = (localStorage.getItem(AGENT_STORAGE_KEY) || '').split(',').filter(Boolean);
                const index = selectedAgents.indexOf(agentName);
                
                if (index > -1) {
                    selectedAgents.splice(index, 1);
                } else {
                    selectedAgents.push(agentName);
                }
                
                localStorage.setItem(AGENT_STORAGE_KEY, selectedAgents.join(','));
                
                // Update UI button state immediately
                const btn = document.getElementById(`btn-${agentName}`);
                if (btn) {
                    btn.classList.toggle('agent-selected');
                    btn.classList.toggle('agent-unselected');
                }
            }

            function getStoredAgentsForHxVals() {
                const agents = localStorage.getItem(AGENT_STORAGE_KEY) || '';
                return agents;
            }

            // HTMX event listeners for dynamic behavior
            document.body.addEventListener('htmx:configRequest', function(evt) {
                // Add storageAgents to every GET request if not present
                if(evt.detail.verb === 'get') {
                     // Check if storageAgents is already in parameters to avoid duplication or override if needed
                     // But simpler is to let hx-vals handle it on specific elements or inject here
                }
            });
        </script>
    </body>
</html>
